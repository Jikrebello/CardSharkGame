@startuml Turn Loop Diagram
title Turn Loop - Activity Diagram

start
repeat
  :Turn Start;
  :Compute pBomb = clamp(0.20 + 0.06*streak, 0.20, 0.56);
  if (jammerTurns > 0?) then (yes)
    :pBomb = max(0, pBomb - 0.15);
    :jammerTurns--;
  endif

  :Roll bomb presence with pBomb;
  if (Bomb present?) then (yes)
    :Slots = {Bomb, Treasure};
  else (no)
    :Slots = {Treasure, Treasure};
  endif
  :Randomly assign Left/Right;
  :Show shuffle animation;

  if (runUniques.size > 0?) then (yes)
    :Input options = Flip L / Flip R / BANK;
  else (no)
    :Input options = Flip L / Flip R;
  endif

  if (Player chose BANK?) then (yes)
    :u = runUniques.size;
    :payout = BankPoints(u);
    :totalScore += payout;
    :Update Trophy Tier;
    :Run Reset (safe);
  else (no)
    :Player flips a slot;

    if (Revealed Bomb?) then (yes)
      if (runHasShield?) then (yes)
        :Consume shield;
        :streak = 0 (penalty);
        :Continue run;
      else (no)
        :lives--;
        if (lives == 0?) then (yes)
          :Game Over;
          stop
        else (no)
          :Run Reset (bomb);
        endif
      endif
    else (no)
      :Revealed Treasure;
      :streak++;
      :Loot draw;

      if (Loot is Joker?) then (yes)
        if (Shield?) then (shield)
          :runHasShield = true;
        elseif (Scrambler?) then (scrambler)
          :scramblerCharges += 2;
          if (scramblerCharges > 4?) then (yes)
            :scramblerCharges = 4;
          endif
        else (Jammer)
          :jammerTurns = 3;
        endif
      else (no)
        :Loot is Number n;

        if (n in runUniques?) then (duplicate)
          if (runHasShield?) then (yes)
            :Consume shield;
            :Ignore bust;
          elseif (scramblerCharges > 0?) then (yes)
            :scramblerCharges--;
            :Reroll number once;
            if (reroll duplicate?) then (yes)
              :Run Reset (duplicate bust);
            else (no)
              :Add reroll number to runUniques;
            endif
          else (no)
            :Run Reset (duplicate bust);
          endif
        else (new)
          :Add n to runUniques;
        endif
      endif
    endif
  endif
  :Next Turn;
repeat while (lives > 0) is (yes)
:Game Over;
stop
@enduml